<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xenialsoft.api.core.event.mapper.EventMapper">

    <resultMap id="event" type="Event">
        <id     property="id"               column="id" />
        <result property="title"            column="title" />
        <result property="description"      column="description" />
        <result property="imageId"          column="image_id" />
        <result property="startDate"        column="start_date" />
        <result property="endDate"          column="end_date" />
        <result property="postId"           column="post_id" />
        <result property="status"           column="status" />
        <result property="createdAt"        column="created_at" />
        <result property="createdBy"        column="created_by" />
        <result property="modifiedAt"       column="modified_at" />
        <result property="modifiedBy"       column="modified_by" />
        <association property="post" javaType="Post">
            <id     property="id"       column="post_id" />
            <result property="title"    column="post_title" />
            <result property="content"  column="post_content" />
            <result property="status"   column="post_status" />
        </association>
    </resultMap>

    <sql id="conditions">
        <!-- 타입(진행상태)로 조회 -->
        <if test='search.progressType != null'>
            <choose>
                <when test='"BEFORE".equals(search.progressType.name())'>
                    and a.start_date <![CDATA[ > ]]> DATE(NOW())
                </when>
                <when test='"ONGOING".equals(search.progressType.name())'>
                    and a.start_date <![CDATA[ <= ]]> DATE(NOW())
                    and a.end_date <![CDATA[ >= ]]> DATE(NOW())
                </when>
                <when test='"ENDED".equals(search.progressType.name())'>
                    and a.end_date <![CDATA[ < ]]> DATE(NOW())
                </when>
            </choose>
        </if>
        
        <!-- 이벤트 식별자로 조회 -->
        <if test='search.eventIds != null and search.eventIds.size() > 0'>
            and a.id in
            <foreach item="eventId" collection="search.eventIds" open="(" separator="," close=")">
                #{eventId}
            </foreach>
        </if>
        
        <!-- 상태로 조회 -->
        <choose>
            <when test='search.status != null'>
                and a.status = #{search.status}
            </when>
            <otherwise>
                and a.status != 'DELETED'
            </otherwise>
        </choose>
        
        <!-- 검색어로 조회 -->
        <if test="search.text != null and search.text.trim().length() > 0">
            and (
                a.title like concat('%', #{search.text}, '%')
            )
        </if>
    </sql>
    
    <select id="selectList" resultMap="event">
        select a.id
             , a.title
             , a.description
             , a.image_id
             , a.start_date
             , a.end_date
             , a.post_id
             , b.title          as post_title
             , b.status         as post_status
             , a.status
             , a.created_at
             , u1.nickname      as created_by
             , a.modified_at
             , u2.nickname      as modified_by
          from event a
     left join post b
            on b.id = a.post_id
     left join user u1
            on u1.id = a.created_by
     left join user u2
            on u2.id = a.modified_by
        <where>
            <include refid="conditions" />
        </where>
        order by a.created_at desc
        <if test='!paging.unpaged'>
            limit #{paging.limit}
            offset #{paging.offset}
        </if>
    </select>
    
    <select id="selectTotalCount" resultType="long">
        select count(*)
          from event a
        <where>
            <include refid="conditions" />
        </where>
    </select>
    
    <select id="selectById" resultMap="event">
        select a.id
             , a.title
             , a.description
             , a.image_id
             , a.start_date
             , a.end_date
             , a.post_id
             , b.title          as post_title
             , b.content        as post_content
             , b.status         as post_status
             , a.status
             , a.created_at
             , u1.nickname      as created_by
             , a.modified_at
             , u2.nickname      as modified_by
          from event a
     left join post b
            on b.id = a.post_id
     left join user u1
            on u1.id = a.created_by
     left join user u2
            on u2.id = a.modified_by
         where a.id = #{id}
    </select>

    <insert id="insert">
        insert into event (
            id,
            title,
            description,
            image_id,
            start_date,
            end_date,
            post_id,
            status,
            created_by
        ) values (
            #{id},
            #{title},
            #{description},
            #{imageId},
            #{startDate},
            #{endDate},
            #{postId},
            #{status},
            #{createdBy}
        )
    </insert>
    
    <update id="update">
        update event
        <set>
            <if test='title != null'>
                title = #{title},
            </if>
            <if test='description != null'>
                description = #{description},
            </if>
            <if test='imageId != null'>
                image_id = #{imageId},
            </if>
            <if test='startDate != null'>
                start_date = #{startDate},
            </if>
            <if test='endDate != null'>
                end_date = #{endDate},
            </if>
            <if test='status != null'>
                status = #{status},
            </if>
            modified_by = #{modifiedBy}
        </set>
         where id = #{id}
    </update>

</mapper>