<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.xenialsoft.api.core.appointment.mapper.AppointmentMapper">

    <resultMap id="appointment"     type="Appointment">
        <id     property="id"               column="id" />
        <result property="type"             column="type" />
        <result property="userId"           column="user_id" />
        <result property="nickname"         column="nickname" />
        <result property="contact"          column="contact" />
        <result property="content"          column="content" />
        <result property="date"             column="date" />
        <result property="memo"             column="memo" />
        <result property="status"           column="status" />
        <result property="privacyAgreed"    column="is_privacy_agreed" />
        <result property="ageConfirmed"     column="is_age_confirmed" />
        <result property="marketingAgreed"  column="is_marketing_agreed" />
        <result property="createdAt"        column="created_at" />
    </resultMap>
    
    <sql id="conditions">
        <!-- 타입으로 조회 -->
        <if test='search.type != null'>
            and a.type = #{search.type} 
        </if>
        
        <!-- 상태로 조회 -->
        <choose>
            <when test='search.status != null'>
                and a.status = #{search.status}
            </when>
            <otherwise>
                and a.status != 'DELETED'
            </otherwise>
        </choose>
        
        <!-- 예약자 식별자로 조회 -->
        <if test='search.userId != null and search.userId.trim().length() > 0'>
            and a.user_id = #{search.userId}
        </if>
        
        <!-- 예약자명으로 조회 -->
        <if test='search.nickname != null and search.nickname.trim().length() > 0'>
            and a.nickname like concat('%', #{search.nickname} , '%')
        </if>
        
        <!-- 예약자 연락처로 조회 -->
        <if test='search.contact != null and search.contact.trim().length() > 0'>
            and a.contact like concat('%', #{search.contact} , '%')
        </if>
        
        <!-- 내용으로 조회 -->
        <if test='search.content != null and search.content.trim().length() > 0'>
            and a.content like concat('%', #{search.content} , '%')
        </if>
    </sql>
    
    
    <select id="selectList" resultMap="appointment">
        select a.id
             , a.type
             , a.nickname
             , a.contact
             , a.content
             , a.date
             , a.is_marketing_agreed
             , a.memo
             , a.status
             , a.created_at
          from appointment a
        <where>
              <include refid="conditions" />
        </where>
        <choose>
            <when test='search.sort != null and "APPOINTMENT_DATE_DESC".equals(search.sort.name())'>
                order by a.date desc
            </when>
            <otherwise>
                order by a.created_at desc
            </otherwise>
        </choose>
        <if test="!paging.unpaged">
            limit #{paging.limit}
            offset #{paging.offset}
        </if>
    </select>
    
    <select id="selectTotalCount" resultType="long">
        select count(*)
          from appointment a
        <where>
            <include refid="conditions" />
        </where>
    </select>
    
    <select id="selectById" resultMap="appointment">
        select a.id
             , a.type
             , a.user_id
             , a.nickname
             , a.contact
             , a.content
             , a.date
             , a.memo
             , a.status
          from appointment a
         where a.id = #{id}
    </select>
    
    <insert id="insert">
        insert into appointment (
            id,
            type,
            user_id,
            nickname,
            contact,
            content,
            date,
            status,
            is_privacy_agreed,
            is_age_confirmed,
            is_marketing_agreed
        ) values (
            #{id},
            #{type},
            #{userId},
            #{nickname},
            #{contact},
            #{content},
            #{date},
            #{status},
            #{privacyAgreed},
            #{ageConfirmed},
            #{marketingAgreed}
        )
    </insert>
    
    <update id="update">
        update appointment
        <set>
            <if test="date != null">
                date = #{date},
            </if>
            <if test="memo != null">
                memo = #{memo},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
            modified_by = #{modifiedBy}
        </set>
        where id = #{id}
    </update>

</mapper>